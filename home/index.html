<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .description {
            max-height: 60px; /* Adjust height for truncation */
            overflow: hidden;
            position: relative;
        }
        .read-more {
            color: #3B82F6; /* Tailwind's blue-500 */
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-[#1E1E2F] text-white">
    <div class="max-w-md mx-auto p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4" id="userProfile">
            <div class="flex items-center space-x-2">
                <img src="https://placehold.co/40x40" alt="Profile picture" id="profilePicture" class="w-10 h-10 rounded-full">
                <span class="font-bold" id="userName">User Name</span>
            </div>
            <button id="logoutButton" class="bg-red-500 px-3 py-1 rounded-md">Logout</button>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="flex items-center justify-center hidden mb-4">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-blue-500"></div>
        </div>

        <!-- Posts Section -->
        <div id="postsContainer" class="space-y-4"></div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 bg-[#2A2A3B] p-4 flex justify-between items-center">
            <i class="fas fa-home text-xl text-blue-500 cursor-pointer" onclick="navigate('home')"></i>
            <i class="fas fa-search text-xl text-gray-400 cursor-pointer" onclick="navigate('search')"></i>
            <div class="bg-blue-500 p-2 rounded-full cursor-pointer" onclick="navigate('addEvent')">
                <i class="fas fa-plus text-xl text-white"></i>
            </div>
            <i class="fas fa-user text-xl text-gray-400 cursor-pointer" onclick="navigate('profile')"></i>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBd1hHYd-GmINKv0l0qwi_10udbiLsTeX0",
            authDomain: "quizzz-998c0.firebaseapp.com",
            databaseURL: "https://quizzz-998c0-default-rtdb.firebaseio.com",
            projectId: "quizzz-998c0",
            storageBucket: "quizzz-998c0.appspot.com",
            messagingSenderId: "320059830331",
            appId: "1:320059830331:web:221f1eebb6e363cc78ac1e"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth();
    
        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html"; // Replace with your login page URL
            } else {
                // Set user name and profile picture
                document.getElementById('userName').textContent = user.displayName || "User Name";
                document.getElementById('profilePicture').src = user.photoURL || "https://placehold.co/40x40"; // Default image if none

                displayPosts(); // Call the function to display posts for all users
            }
        });

        function displayPosts() {
            const postsContainer = document.getElementById('postsContainer');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            loadingSpinner.classList.remove('hidden'); // Show spinner
            const usersRef = ref(db, 'users'); // Reference to the users node
            
            onValue(usersRef, usersSnapshot => {
                postsContainer.innerHTML = ''; // Clear previous events
                loadingSpinner.classList.add('hidden'); // Hide spinner
        
                usersSnapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    const events = userData.events;
        
                    if (events) {
                        for (const eventKey in events) {
                            const eventData = events[eventKey];
                            
                            // Create HTML for each event using provided structure
                            const eventHTML = `
                                <div class="bg-[#2A2A3B] p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <img src="${eventData.uploaderPhoto || 'https://placehold.co/40x40'}" alt="User profile picture" class="w-10 h-10 rounded-full">
                                            <div>
                                                <span class="font-bold">${eventData.uploaderName || "User Name"}</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button class="text-gray-400 flex items-center space-x-1" onclick="likePost('${userSnapshot.key}', '${eventKey}')">
                                                <i class="fas fa-thumbs-up"></i>
                                                <span id="likeCount-${eventKey}">${eventData.likeCount || 0}</span>
                                            </button>
                                            <button class="text-gray-400 flex items-center space-x-1" onclick="sharePost('${eventData.eventLink}')">
                                                <i class="fas fa-share"></i>
                                                <span id="shareCount-${eventKey}">${eventData.shareCount || 0}</span>
                                            </button>
                                        </div>
                                    </div>
                                    <img src="${eventData.image}" alt="Event image" class="w-full h-60 object-cover rounded-md mb-2">
                                    <div class="mb-2">
                                        <span class="font-bold">Event Date:</span> 
                                        <span>${eventData.eventDate}</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="font-bold">Event Time:</span> 
                                        <span>${eventData.eventTime}</span>
                                    </div>
                                    <p class="description text-sm mb-2">${eventData.description.length > 100 ? eventData.description.substring(0, 100) + '...' : eventData.description}</p>
                                    ${eventData.description.length > 100 ? `<span class="read-more underline" onclick="toggleDescription(this, '${eventData.description}')">Read More</span>` : ''}
                                    <p class="text-sm mb-2">
                                        <span class="text-blue-500">#${eventData.tags.join(', ')}</span>
                                    </p>
                                    <div class="flex items-center justify-between text-gray-400 text-sm">
                                        <a href="${eventData.locationLink}" target="_blank" class="underline">Location</a>
                                    </div>
                                </div>
                            `;
                            postsContainer.innerHTML += eventHTML; // Append event to posts container
                        }
                    }
                });
            }, (error) => {
                console.error("Error fetching posts:", error);
                loadingSpinner.classList.add('hidden'); // Hide spinner on error
            });
        }
        
        
        // Toggle description visibility
        function toggleDescription(element, fullDescription) {
            const descriptionElement = element.previousElementSibling;
            if (descriptionElement.classList.contains('description')) {
                descriptionElement.classList.remove('description');
                descriptionElement.textContent = fullDescription;
                element.textContent = "Read Less";
            } else {
                descriptionElement.classList.add('description');
                descriptionElement.textContent = fullDescription.substring(0, 100) + '...';
                element.textContent = "Read More";
            }
        }
        
        // Like post functionality
        window.likePost = function(userKey, eventKey) {
            const likeCountElement = document.getElementById(`likeCount-${eventKey}`);
            const currentCount = parseInt(likeCountElement.textContent);
            const newCount = currentCount + 1;
            likeCountElement.textContent = newCount;

            // Update the Firebase database for the specific event
            const postRef = ref(db, `users/${userKey}/events/${eventKey}`);
            update(postRef, { likeCount: newCount })
                .catch(error => console.error("Error updating like count:", error));
        }

        // Share post functionality
        window.sharePost = function(eventLink) {
            const shareCountElement = document.getElementById(`shareCount-${eventLink}`);
            const currentCount = parseInt(shareCountElement.textContent);
            const newCount = currentCount + 1;
            shareCountElement.textContent = newCount;

            const postRef = ref(db, `users/${eventLink}`); // Update your Firebase path accordingly
            update(postRef, { shareCount: newCount });

            // Implement share functionality, e.g., using the Web Share API
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this event!',
                    text: 'Check out this amazing event I found!',
                    url: eventLink // Ensure eventLink is a valid URL
                }).catch((error) => console.error('Error sharing:', error));
            } else {
                console.log('Sharing not supported');
            }
        }

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "login.html"; // Redirect to login page
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        });

        // Navigation function (placeholder)
        function navigate(page) {
            console.log(`Navigate to ${page}`);
            // Implement your navigation logic here
        }
    </script>
</body>
</html>
