<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif; /* Change font */
            background-color: #1e1e2f;
        }
        .description {
            max-height: 60px; /* Adjust height for truncation */
            overflow: hidden;
            position: relative;
        }
        .read-more {
            color: #3B82F6; /* Tailwind's blue-500 */
            cursor: pointer;
            transition: color 0.3s; /* Add smooth transition */
        }
        .read-more:hover {
            color: #1D4ED8; /* Darker shade on hover */
        }
        /* Spinner Animation */
        .spinner {
            border: 4px solid transparent;
            border-top-color: #3B82F6; /* Spinner color */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 0.8s linear infinite; /* Smooth spin */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loc{
            color: rgb(175, 203, 255);
            margin-right: 4px;
            margin-bottom: 10px;
        }

        .loc:hover{
            color: #1D4ED8; 
        }
        
       .read-more{
        color: rgb(47, 0, 255);
        text-decoration: underline;
       }

       .tx{
        font-size: 19px;
        margin-right: 15px;
       }

       .da{
        font-size: 12px;
       }

       @media screen and (max-width: 468px){
        .ss{
            margin-left: -1800px;
        }
       }

       .bb{
        z-index: 1000;
       }

       .glow {
        color: #ffdf00; /* Gold color for the liked state */
        text-shadow: 0px 0px 10px rgba(255, 223, 0, 0.8); /* Soft glow effect */
        transition: color 0.3s, text-shadow 0.3s;
    }
    
    </style>
</head>
<body class="text-white">
    <div class="max-w-md mx-auto p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4" id="userProfile">
            <div class="flex items-center space-x-2">
                <img src="https://placehold.co/40x40" alt="Profile picture" id="profilePicture" class="w-10 h-10 rounded-full">
                <span class="font-bold" id="userName">Loading</span>
            </div>
            <div class="flex items-center space-x-4"> <!-- Flexbox for icon alignment and spacing -->
                <div class=" p-2 rounded-full cursor-pointer" onclick="window.location.href='profile.html'">
                    <i class="fas fa-user text-xl text-gray-400"></i>
                </div>
                <div class=" p-2 rounded-full cursor-pointer" onclick="window.location.href='../add/y'">
                    <i class="fas fa-add text-xl text-gray-400"></i>
                </div>
                <div class=" p-2 rounded-full cursor-pointer" onclick="window.location.href='profile.html'">
                    <i class="fas fa-search text-xl text-gray-400"></i>
                </div>
                
            </div>
        </div>
        

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="flex items-center justify-center hidden mb-4">
            <div class="spinner"></div>
        </div>

        <!-- Posts Section -->
        <div id="postsContainer" class="space-y-4"></div>

    

        <script type="module">
            // Import Firebase modules
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
            import { getDatabase, ref, onValue, update,get , remove , set } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBd1hHYd-GmINKv0l0qwi_10udbiLsTeX0",
                authDomain: "quizzz-998c0.firebaseapp.com",
                databaseURL: "https://quizzz-998c0-default-rtdb.firebaseio.com",
                projectId: "quizzz-998c0",
                storageBucket: "quizzz-998c0.appspot.com",
                messagingSenderId: "320059830331",
                appId: "1:320059830331:web:221f1eebb6e363cc78ac1e"
            };
        
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const auth = getAuth();
        
            // Check authentication state
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    window.location.href = "../login/"; // Replace with your login page URL
                } else {
                    // Set user name and profile picture
                    document.getElementById('userName').textContent = user.displayName || "User Name";
                    document.getElementById('profilePicture').src = user.photoURL || "https://placehold.co/40x40"; // Default image if none
        
                    displayPosts(); // Call the function to display posts for all users
                }
            });
        
            // Function to display posts
            function displayPosts() {
                const postsContainer = document.getElementById('postsContainer');
                const loadingSpinner = document.getElementById('loadingSpinner');
        
                loadingSpinner.classList.remove('hidden'); // Show spinner
                const usersRef = ref(db, 'users'); // Reference to the users node
        
                onValue(usersRef, usersSnapshot => {
                    postsContainer.innerHTML = ''; // Clear previous events
                    loadingSpinner.classList.add('hidden'); // Hide spinner
        
                    usersSnapshot.forEach(userSnapshot => {
                        const userData = userSnapshot.val();
                        const events = userData.events;
        
                        if (events) {
                            for (const eventKey in events) {
                                const eventData = events[eventKey];
        
                                // Create HTML for each event using provided structure
                                const eventHTML = `
                                    <div class="bg-[#2A2A3B] p-4 rounded-lg transition-all duration-300 hover:shadow-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center space-x-2">
                                                <img src="${eventData.uploaderPhoto || 'https://placehold.co/40x40'}" alt="User profile picture" class="w-10 h-10 rounded-full">
                                                <div>
                                                    <span class="font-bold">${eventData.uploaderName || "User Name"}</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2 bb">
                                                <button class="text-gray-400 flex items-center space-x-1" id="likeButton-${eventKey}" onclick="likePost('${userSnapshot.key}', '${eventKey}')">
                                                    <i class="fas fa-thumbs-up"></i>
                                                    <span id="likeCount-${eventKey}">${eventData.likeCount || 0}</span>
                                                </button>
                                                <button class="text-gray-400 flex items-center space-x-1" onclick="sharePost('${eventData.eventLink}', '${eventKey}')">
                                                    <i class="fas fa-share"></i>
                                                    <span id="shareCount-${eventKey}">${eventData.shareCount || 0}</span>
                                                </button>
                                            </div>
                                        </div>
                                        <img src="${eventData.image}" alt="Event image" class="w-full h-60 object-cover rounded-md mb-2">
                                        <div class="mb-2">
                                            <span class="font-bold tx"><i class="fa-solid fa-calendar-days"></i></span> 
                                            <span class="da">${eventData.eventDate}</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="font-bold tx"><i class="fa-solid fa-clock-rotate-left"></i></span> 
                                            <span class="da">${eventData.eventTime}</span>
                                        </div>
                                        <div class="flex items-center justify-between text-gray-400 text-sm">
                                            <a href="${eventData.locationLink}" target="_blank" class="loc">Location&nbsp;<i class="fa-solid fa-location-crosshairs" class="loci"></i></a>
                                        </div>
                                        <div class="event-description">
                                            <p class="description text-sm mb-2" id="shortDesc-${eventKey}">
                                                ${eventData.description.length > 100 ? eventData.description.substring(0, 100) + '...' : eventData.description}
                                            </p>
                                            ${eventData.description.length > 100 ? `<span class="read-more">More</span>` : ''}
                                            <p class="full-description text-sm mb-2" style="display:none; margin:0;">
                                                <span>${eventData.description}</span>
                                            </p>
                                        </div>
                                        <p class="text-sm mb-2" style="visibility:hidden; margin:0;">
                                            <span class="text-blue-500">#${eventData.tags.join(', ')}</span>
                                        </p>
                                    </div>
                                `;
                                postsContainer.innerHTML += eventHTML; // Append event to posts container
                            }
        
                            // Re-add the read more functionality for the newly added posts
                            const readMoreButtons = postsContainer.querySelectorAll('.read-more');
        
                            readMoreButtons.forEach(button => {
                                button.addEventListener('click', function() {
                                    const fullDescription = this.nextElementSibling; // Full description
                                    const shortDescription = this.previousElementSibling; // Short description
        
                                    if (fullDescription.style.display === 'none' || fullDescription.style.display === '') {
                                        fullDescription.style.display = 'block'; // Show full description
                                        shortDescription.style.display = 'none'; // Hide short description
                                        this.textContent = 'Hide'; // Change button text
                                    } else {
                                        fullDescription.style.display = 'none'; // Hide full description
                                        shortDescription.style.display = 'block'; // Show short description
                                        this.textContent = 'Hide'; // Change button text
                                    }
                                });
                            });
                        }
                    });
                }, (error) => {
                    console.error("Error fetching posts:", error);
                    loadingSpinner.classList.add('hidden'); // Hide spinner on error
                });
            }
        


window.likePost = async function(userId, eventId) {
    const userRef = ref(db, `users/${userId}/likes/${eventId}`);
    const eventRef = ref(db, `users/${userId}/events/${eventId}`);
    const likeCountElement = document.getElementById(`likeCount-${eventId}`);
    const likeButton = document.getElementById(`likeButton-${eventId}`); // Like button element for glow effect

    try {
        // Get the current like count from Firebase
        const eventSnapshot = await get(eventRef);
        const currentLikes = eventSnapshot.exists() ? (eventSnapshot.val().likeCount || 0) : 0;

        // Check if the user has already liked the post
        const userSnapshot = await get(userRef);

        if (userSnapshot.exists()) {
            // User has already liked, so we remove the like
            const newLikesCount = Math.max(0, currentLikes - 1); // Prevent negative like count
            likeCountElement.textContent = newLikesCount; // Update like count locally
            
            // Correctly update the like count in Firebase
            await update(eventRef, { likeCount: newLikesCount }); 
            await remove(userRef); // Remove like from the user's likes
            likeButton.classList.remove("glow"); // Remove the glow effect
            console.log(`Like removed for Event ID: ${eventId}`);
        } else {
            // User has not liked, so we add the like
            const newLikesCount = currentLikes + 1; // Increase like count
            likeCountElement.textContent = newLikesCount; // Update like count locally
            
            // Correctly set the like count and user like status in Firebase
            await update(eventRef, { likeCount: newLikesCount }); 
            await set(userRef, { liked: true }); // Mark this post as liked by the user
            likeButton.classList.add("glow"); // Add the glow effect
            console.log(`Like added for Event ID: ${eventId}`);
        }
    } catch (error) {
        console.error("Error toggling like status:", error);
    }
};

        
            // Share post function
            window.sharePost = function(eventLink, eventId) {
                const shareCountElement = document.getElementById(`shareCount-${eventId}`);
                const currentShares = parseInt(shareCountElement.textContent);
                shareCountElement.textContent = currentShares + 1; // Update share count locally
                // Implement your share logic here (e.g., copying link to clipboard)
                navigator.clipboard.writeText(eventLink).then(() => {
                    alert("Event link copied to clipboard!");
                });
            }
        
         
        </script>
        
</body>
</html>
