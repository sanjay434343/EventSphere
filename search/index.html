<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Search with Firebase</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBd1hHYd-GmINKv0l0qwi_10udbiLsTeX0",
            authDomain: "quizzz-998c0.firebaseapp.com",
            databaseURL: "https://quizzz-998c0-default-rtdb.firebaseio.com",
            projectId: "quizzz-998c0",
            storageBucket: "quizzz-998c0.appspot.com",
            messagingSenderId: "320059830331",
            appId: "1:320059830331:web:221f1eebb6e363cc78ac1e"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Debounce function to limit the rate at which a function can fire
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function liveSearch(searchTerm) {
            const dbRef = ref(database);
            if (typeof searchTerm !== 'string' || searchTerm.trim() === '') {
                console.error('Search term is invalid:', searchTerm);
                return;
            }
        
            get(dbRef).then((snapshot) => {
                const results = [];
                snapshot.forEach((userSnapshot) => {
                    const userData = userSnapshot.val();
                    if (userData.events) {
                        Object.entries(userData.events).forEach(([eventId, eventData]) => {
                            // Check if the search term matches any relevant fields
                            if (
                                eventData.collegeName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                eventData.eventName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                eventData.eventDate.includes(searchTerm) ||
                                eventData.eventTime.includes(searchTerm) ||
                                eventData.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
                            ) {
                                results.push({ userId: userSnapshot.key, eventId, data: eventData });
                            }
                        });
                    }
                });
                displayResults(results);
            }).catch(error => {
                console.error('Error fetching data:', error);
            });
        }
        

        function displayResults(results) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>No results found.</p>';
                return;
            }
            results.forEach(result => {
                const resultItem = document.createElement('div');
                if (result.eventId) {
                    resultItem.textContent = `User ID: ${result.userId}, Event ID: ${result.eventId}, Event Data: ${JSON.stringify(result.data)}`;
                } else {
                    resultItem.textContent = `User ID: ${result.userId}, User Data: ${JSON.stringify(result.data)}`;
                }
                resultsContainer.appendChild(resultItem);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const debouncedLiveSearch = debounce(liveSearch, 300); // Adjust delay as needed
            searchInput.addEventListener('keyup', function (event) {
                const searchValue = event.target.value;
                debouncedLiveSearch(searchValue);
            });
        });
    </script>
</head>
<body>
    <h1>Live Search Users</h1>
    <input type="text" id="searchInput" placeholder="Search..." />
    <div id="results"></div>
</body>
</html>
